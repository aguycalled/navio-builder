#!/usr/bin/env bash

MAIN_DIR="/navio"
LOCKFILE="$MAIN_DIR/.lock"
BUILDS_DIR="$MAIN_DIR/builds"
REPO_DIR="$MAIN_DIR/navio-core"
HASH_FILE="$MAIN_DIR/hash.txt"
GPG_KEY="4DC1A6D4CB76395724FB97DBA05B6DF4513EA050"

if [ -z "$GPG_KEY" ]; then
    echo "ERROR: GPG_KEY is not set. Export GPG_KEY to your key id/fingerprint before running." >&2
    exit 1
fi

if [ -e "$LOCKFILE" ]; then
    exit 1
fi

touch "$LOCKFILE"

cleanup() {
    rm -f "$LOCKFILE"
}
trap cleanup EXIT

cd "$REPO_DIR"
git fetch --all
git checkout -f origin/master

# ─── Extract version from configure.ac (only from define(...) lines) ─────────
VERSION_MAJOR=$(sed -n 's/^define(_CLIENT_VERSION_MAJOR, *\([0-9]\+\)).*/\1/p' configure.ac)
VERSION_MINOR=$(sed -n 's/^define(_CLIENT_VERSION_MINOR, *\([0-9]\+\)).*/\1/p' configure.ac)
VERSION_BUILD=$(sed -n 's/^define(_CLIENT_VERSION_BUILD, *\([0-9]\+\)).*/\1/p' configure.ac)
VERSION_RC=$(sed -n 's/^define(_CLIENT_VERSION_RC, *\([0-9]\+\)).*/\1/p' configure.ac)
IS_RELEASE=$(sed -n 's/^define(_CLIENT_VERSION_IS_RELEASE, *\([^)]\+\)).*/\1/p' configure.ac)

if [ -z "$VERSION_MAJOR" ] || [ -z "$VERSION_MINOR" ] || [ -z "$VERSION_BUILD" ] || [ -z "$VERSION_RC" ]; then
    echo "ERROR: Could not parse version from configure.ac" >&2
    exit 1
fi

# Compose version string, e.g. 1.0.0-rc0 or 1.0.0
VERSION="${VERSION_MAJOR}.${VERSION_MINOR}.${VERSION_BUILD}-rc${VERSION_RC}"
if [ "$IS_RELEASE" = "true" ]; then
    VERSION="${VERSION_MAJOR}.${VERSION_MINOR}.${VERSION_BUILD}"
fi

echo "Using version: $VERSION"

CURRENT_HASH=$(git rev-parse --short=12 HEAD)
LAST_HASH=$(cat "$HASH_FILE" 2>/dev/null || echo "")

HOSTS_ALL="x86_64-linux-gnu arm-linux-gnueabihf aarch64-linux-gnu riscv64-linux-gnu powerpc64-linux-gnu powerpc64le-linux-gnu x86_64-w64-mingw32 x86_64-apple-darwin arm64-apple-darwin"

export SDK_PATH="$MAIN_DIR/SDKs"

if [ "$CURRENT_HASH" != "$LAST_HASH" ]; then
    : > "$BUILDS_DIR/build.log.txt"
    echo "$CURRENT_HASH" > "$HASH_FILE"

    echo "Building commit: $CURRENT_HASH (version $VERSION)"
    pushd "$REPO_DIR" >/dev/null

    for HOST in $HOSTS_ALL; do
        echo "Processing: $HOST"
        HOSTS="$HOST" ./contrib/guix/guix-clean
        HOSTS="$HOST" ./contrib/guix/guix-build

        # Files still live in the commit-hash-based guix output dir
        FILES=$(ls guix-build-"$CURRENT_HASH"/output/"$HOST"/*.{zip,tar.gz} 2>/dev/null || true)

        for FILE in $FILES; do
            ORIG_BASENAME="$(basename "$FILE")"

            # Replace commit hash in filename with version (navio-<hash>-... -> navio-<version>-...)
            BASENAME="${ORIG_BASENAME/$CURRENT_HASH/$VERSION}"

            DESTFILE="$BUILDS_DIR/$BASENAME"

            echo "Copying $ORIG_BASENAME -> $BASENAME"
            cp "$FILE" "$DESTFILE"

            # Update "latest" symlink: navio-<version>-host.tar.gz -> navio-latest-host.tar.gz
            LATEST_NAME="${BASENAME/$VERSION/latest}"
            rm -f "$BUILDS_DIR/$LATEST_NAME"
            ln -s "$DESTFILE" "$BUILDS_DIR/$LATEST_NAME"

            # Cleanup old files
            find "$BUILDS_DIR" -mtime +2 -type f -delete
        done

        HOSTS="$HOST" ./contrib/guix/guix-clean
    done

    # ─── Create combined SHA256 files + signatures ────────────────────────────
    (
        cd "$BUILDS_DIR" || exit 1

        shopt -s nullglob

        # 1) All artifacts for this specific VERSION
        current_files=( *"$VERSION"*.tar.gz *"$VERSION"*.zip )
        if ((${#current_files[@]})); then
            SHA_FILE="SHA256SUMS-$VERSION.asc"
            sha256sum "${current_files[@]}" > "$SHA_FILE"
            echo "Wrote SHA256 sums to $BUILDS_DIR/$SHA_FILE"

            gpg --batch --yes --local-user "$GPG_KEY" \
                --output "$SHA_FILE.sig" \
                --detach-sign "$SHA_FILE"
            echo "Signed $SHA_FILE -> $SHA_FILE.sig"
        fi

        # 2) All artifacts named with 'latest'
        latest_files=( *latest*.tar.gz *latest*.zip )
        if ((${#latest_files[@]})); then
            LATEST_SHA_FILE="SHA256SUMS-latest.asc"
            sha256sum "${latest_files[@]}" > "$LATEST_SHA_FILE"
            echo "Wrote SHA256 sums to $BUILDS_DIR/$LATEST_SHA_FILE"

            gpg --batch --yes --local-user "$GPG_KEY" \
                --output "$LATEST_SHA_FILE.sig" \
                --detach-sign "$LATEST_SHA_FILE"
            echo "Signed $LATEST_SHA_FILE -> $LATEST_SHA_FILE.sig"
        fi
    )

    popd >/dev/null
fi
